\'use server\';\n\nimport { GoogleGenerativeAI } from \'@google/generative-ai\';\n\n// IMPORTANT: Remember to set your GOOGLE_API_KEY in the environment variables.\nconst genAI = new GoogleGenerativeAI(process.env.GOOGLE_API_KEY as string);\n\nconst model = genAI.getGenerativeModel({ model: \"gemini-1.5-flash\" });\n\nconst prompt = `\n  You are an expert English tutor AI for a diary application called \'Logue\'.\n  Your user has written a diary entry. Your task is to analyze it and provide feedback in a structured JSON format.\n  \n  Please perform the following steps:\n  1.  **Correct the entry**: Rewrite the user\'s text to make it more natural and fluent, as a native speaker would write it.\n  2.  **Explain your changes**: Briefly explain the key corrections you made. Focus on why the suggested version is more natural (e.g., \"fruitful\" is a better word than \"productive\" here because...).\n  3.  **Provide a fluency score**: Rate the user\'s original text on a scale of 0 to 100 for overall fluency.\n  4.  **Extract key expressions**: Identify 1-3 important words or phrases from your corrected version that the user should learn.\n\n  The user\'s entry must be returned as a single, minified JSON object. Do not wrap it in markdown code blocks (like \\\`\\\`\\\`json).\n  The JSON object should have the following structure: { \"correctedText\": \"...\", \"explanation\": \"...\", \"fluencyScore\": ..., \"keyExpressions\": [\"...\", \"...\"] }\n  \n  Analyze the following diary entry:\n`;\n\nexport async function analyzeDiaryEntry(entry: string) {\n  // Basic check for the API key availability.\n  if (!process.env.GOOGLE_API_KEY) {\n    return {\n      error: \"Server configuration error: The GOOGLE_API_KEY is not set. Please contact the administrator.\"\n    };\n  }\n\n  try {\n    const fullPrompt = `${prompt} \"${entry}\"`;\n    const result = await model.generateContent(fullPrompt);\n    const response = await result.response;\n    const text = response.text();\n\n    // The model should return a raw JSON string. Let\'s parse it.\n    const jsonResponse = JSON.parse(text);\n\n    return {\n      correctedText: jsonResponse.correctedText,\n      explanation: jsonResponse.explanation,\n      fluencyScore: jsonResponse.fluencyScore,\n      keyExpressions: jsonResponse.keyExpressions,\n    };\n\n  } catch (error: any) {\n    console.error(\"Error analyzing diary entry:\", error);\n    // Return a more descriptive error message to the client for debugging.\n    return {\n      error: `An error occurred while analyzing the entry. Details: ${error.message}`\n    };\n  }\n}\n